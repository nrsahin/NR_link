<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up | Secure Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white shadow-xl rounded-2xl w-full max-w-md overflow-hidden">
        <div class="p-8">
            <div id="registration-step">
                <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Create Account</h2>
                <p class="text-slate-500 mb-8">Join us to get started.</p>
                
                <form id="signupForm" class="space-y-4">
                    
                     <div class="flex flex-col items-center mb-6">
                        <div class="relative group">
                            <img id="profile-preview" 
                                src="https://static.vecteezy.com/system/resources/previews/021/548/095/original/default-profile-picture-avatar-user-avatar-icon-person-icon-head-icon-profile-picture-icons-default-anonymous-user-male-and-female-businessman-photo-placeholder-social-network-avatar-portrait-free-vector.jpg" 
                                alt="Profile Preview" 
                                class="w-24 h-24 rounded-full object-cover border-4 border-slate-100 shadow-md">
                            
                            <label for="profile-photo-input" 
                                class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full text-white cursor-pointer hover:bg-blue-700 transition shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </label>
                        </div>
                        <input type="file" id="profile-photo-input" accept="image/*" class="hidden">
                        <p class="text-xs text-slate-400 mt-2">Click icon to upload photo</p>
                    </div>

                    <div class="relative">
                        <span class="absolute left-4 top-3 text-slate-400 font-bold">#</span>
                        <input type="text" id="user_id" placeholder="user id (max 8 characters)" required 
                            maxlength="8" 
                            pattern="[A-Za-z0-9]{1,7}"
                            oninput="this.value = this.value.replace(/[^A-Za-z0-9]/g, '')"
                            class="w-full pl-8 pr-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm"
                            title="Only letters and numbers allowed, up to 7 characters after #">
                    </div>
                    <input type="text" id="fullName" placeholder="Full Name" required class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                    <input type="date" id="age" required class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                    <select id="gender" required class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="tel" id="phone" pattern="[0-9]{10}" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="Phone Number (10 digits)" class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                    <input type="email" id="email" placeholder="Email Address" required class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                    <input type="password" id="password" placeholder="Password" required minlength="6" class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">
                    <input type="password" id="confirmPassword" placeholder="Confirm Password" required minlength="6" class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white focus:ring-0 text-sm">

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200">Continue</button>
                </form>
                <p class="mt-4 text-center text-sm text-slate-600">Already have an account? <a href="signin.html" class="text-blue-600 font-semibold">signin</a></p>
            </div>

            <div id="otp-step" class="hidden">
                <h2 class="text-3xl font-extrabold text-slate-800 mb-2 text-center">Verify Email</h2>
                <p class="text-slate-500 mb-8 text-center">Enter the 6-digit code sent to your email.</p>
                
                <form id="verifyForm" class="space-y-6">
                    <div class="flex justify-between gap-2" id="otp-inputs">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                        <input type="text" maxlength="1" class="otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 focus:bg-white outline-none transition-all">
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-green-100">Verify & Register</button>
                    <button type="button" onclick="resendOTP()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Resend Code</button>
                </form>
            </div>
        </div>
    </div>
    <div id="crop-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full overflow-hidden">
            <div class="p-4 border-b">
                <h3 class="font-bold text-slate-800">Crop Profile Photo</h3>
            </div>
            <div class="max-h-[60vh] overflow-hidden bg-slate-200">
                <img id="cropping-image" class="max-w-full block">
            </div>
            <div class="p-4 flex gap-3">
                <button id="cancel-crop" class="flex-1 py-2 bg-slate-200 rounded-lg font-semibold">Cancel</button>
                <button id="apply-crop" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-semibold">Save & Finish</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        const API_BASE =  window.CONFIG.API_BASE;
        
        let userEmail = "";
        let cropper;
        let croppedBase64 = null; 

        const photoInput = document.getElementById('profile-photo-input');
        const photoPreview = document.getElementById('profile-preview');
        const cropModal = document.getElementById('crop-modal');
        const croppingImage = document.getElementById('cropping-image');

        document.getElementById("profile-preview").addEventListener("click", () => { document.getElementById("profile-photo-input").click(); });
        // --- Profile Photo & Cropping Logic ---

        photoInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    croppingImage.src = event.target.result;
                    cropModal.classList.remove('hidden'); 
                    
                    if (cropper) cropper.destroy(); 
                    cropper = new Cropper(croppingImage, {
                        aspectRatio: 1, 
                        viewMode: 1,
                        autoCropArea: 1
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        document.getElementById('apply-crop').onclick = () => {
            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 300
            });
            
            croppedBase64 = canvas.toDataURL('image/jpeg', 0.8); // 0.8 quality to keep payload small
            photoPreview.src = croppedBase64;
            cropModal.classList.add('hidden');
        };

        document.getElementById('cancel-crop').onclick = () => {
            cropModal.classList.add('hidden');
            photoInput.value = ""; 
        };

        // --- Utility: Toggle Loading ---
        const setLoader = (formId, isLoading) => {
            const btn = document.querySelector(`#${formId} button[type="submit"]`);
            btn.disabled = isLoading;
            btn.innerText = isLoading ? "Processing..." : (formId === 'signupForm' ? "Continue" : "Verify & Register");
            btn.style.opacity = isLoading ? "0.7" : "1";
        };

        // --- Form Submissions ---

        document.getElementById('signupForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Simple validation
            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }

            setLoader('signupForm', true);
            userEmail = document.getElementById('email').value;

            const payload = {
                user_id: "#" + document.getElementById('user_id').value,
                fullName: document.getElementById('fullName').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                phone: document.getElementById('phone').value,
                email: userEmail,
                password: password,
                photo: croppedBase64 
            };

            try {
                const res = await fetch(`${API_BASE}/signup`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if(data.success) {
                    document.getElementById('registration-step').classList.add('hidden');
                    document.getElementById('otp-step').classList.remove('hidden');
                } else { 
                    alert(data.message || "Signup failed"); 
                }
            } catch (err) {
                alert("Server connection error. Please try again.");
            } finally {
                setLoader('signupForm', false);
            }
        };

        const boxes = document.querySelectorAll('.otp-box');
        boxes.forEach((box, index) => {
            box.addEventListener('input', (e) => {
                if (e.target.value && index < boxes.length - 1) boxes[index + 1].focus();
            });
            box.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) boxes[index - 1].focus();
            });
        });

        // Modified verifyForm Submission
        document.getElementById('verifyForm').onsubmit = async (e) => {
            e.preventDefault();
            const otpValue = Array.from(boxes).map(b => b.value).join('');
            if(otpValue.length < 6) return alert("Enter full code");

            setLoader('verifyForm', true);
            try {
                const res = await fetch(`${API_BASE}/signup/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: userEmail, otp: otpValue })
                });
                const data = await res.json();
                if(data.success) {
                    alert("Account Created!");
                    window.location.href = "signin.html";
                } else { alert(data.message); }
            } catch (err) { alert("Error connecting to server"); }
            finally { setLoader('verifyForm', false); }
        };

        async function resendOTP() {
            try {
                const res = await fetch(`${API_BASE}/signup/resend`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: userEmail })
                });
                const data = await res.json();
                alert(data.message || "New code sent!");
            } catch (err) {
                alert("Could not resend code.");
            }
        }
    </script>
</body>
</html>