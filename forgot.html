<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | Secure Auth</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white shadow-xl rounded-2xl w-full max-w-md p-8">
        <div id="request-step">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Forgot Password?</h2>
            <p class="text-slate-500 mb-6">Enter your email to receive a reset code.</p>
            <form id="requestForm" class="space-y-4">
                <input type="email" id="reqEmail" placeholder="Email Address" required class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 focus:bg-white outline-none">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Send Code</button>
            </form>
        </div>

        <div id="reset-step" class="hidden">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">New Password</h2>
            <p class="text-slate-500 mb-6">Enter the code and your new password.</p>
            <form id="resetForm" class="space-y-6">
                <div class="flex justify-between gap-2" id="reset-otp-inputs">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                    <input type="text" maxlength="1" class="reset-otp-box w-12 h-14 text-center text-2xl font-bold bg-slate-100 border-2 border-transparent rounded-xl focus:border-blue-500 outline-none">
                </div>
                <input type="password" id="newPass" placeholder="New Password" required minlength="6" class="w-full px-4 py-3 rounded-lg bg-slate-100 border-transparent focus:border-blue-500 outline-none">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">Update Password</button>
                <button type="button" onclick="resendResetOTP()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Resend Code</button>
            </form>
        </div>
        
        <div class="mt-4 text-center">
            <a href="signin.html" class="text-sm text-slate-500 hover:text-blue-600">‚Üê Back to signin</a>
        </div>
    </div>

    <script src="config.js"></script>

    <script>
        const API_BASE = window.CONFIG.API_BASE;
        let targetEmail = "";

        // --- OTP Box Logic ---
        // Handles auto-focusing to the next box and backspacing
        const boxes = document.querySelectorAll('.reset-otp-box');
        boxes.forEach((box, index) => {
            box.addEventListener('input', (e) => {
                // Move to next box if value entered
                if (e.target.value && index < boxes.length - 1) {
                    boxes[index + 1].focus();
                }
            });

            box.addEventListener('keydown', (e) => {
                // Move to previous box on backspace if current box is empty
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    boxes[index - 1].focus();
                }
            });
        });

        // --- Utility: Toggle Loading ---
        const setLoader = (formId, isLoading) => {
            const btn = document.querySelector(`#${formId} button[type="submit"]`);
            if (!btn) return;
            btn.disabled = isLoading;
            btn.innerText = isLoading ? "Processing..." : (formId === 'requestForm' ? "Send Code" : "Update Password");
            btn.style.opacity = isLoading ? "0.7" : "1";
        };

        // --- Step 1: Request Reset Code ---
        document.getElementById('requestForm').onsubmit = async (e) => {
            e.preventDefault();
            targetEmail = document.getElementById('reqEmail').value;
            
            setLoader('requestForm', true);
            try {
                const res = await fetch(`${API_BASE}/forgot-password/request`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: targetEmail })
                });
                const data = await res.json();
                
                if(data.success) {
                    document.getElementById('request-step').classList.add('hidden');
                    document.getElementById('reset-step').classList.remove('hidden');
                    // Auto-focus first OTP box
                    setTimeout(() => boxes[0].focus(), 100);
                } else { 
                    alert(data.message || "Failed to send reset code."); 
                }
            } catch (err) {
                alert("Connection error. Please check your server.");
            } finally {
                setLoader('requestForm', false);
            }
        };

        // --- Step 2: Verify OTP & Reset Password ---
        document.getElementById('resetForm').onsubmit = async (e) => {
            e.preventDefault();
            
            // Combine individual box values into a single string
            const otpValue = Array.from(boxes).map(b => b.value).join('');
            const newPass = document.getElementById('newPass').value;
            
            if (otpValue.length < 6) {
                alert("Please enter the full 6-digit code.");
                return;
            }

            setLoader('resetForm', true);
            try {
                const res = await fetch(`${API_BASE}/forgot-password/reset`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: targetEmail,
                        otp: otpValue,
                        password: newPass
                    })
                });
                const data = await res.json();
                
                if(data.success) {
                    alert("Password changed successfully! Redirecting to sign in...");
                    window.location.href = "signin.html";
                } else {
                    alert(data.message || "Reset failed. Check your code.");
                }
            } catch (err) {
                alert("Connection error. Please try again.");
            } finally {
                setLoader('resetForm', false);
            }
        };

        // --- Resend Function ---
        async function resendResetOTP() {
            try {
                const res = await fetch(`${API_BASE}/forgot-password/request`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: targetEmail })
                });
                const data = await res.json();
                alert(data.message || "Reset code resent!");
                // Clear boxes and focus first
                boxes.forEach(b => b.value = "");
                boxes[0].focus();
            } catch (err) {
                alert("Could not resend code.");
            }
        }
    </script>
</body>
</html>